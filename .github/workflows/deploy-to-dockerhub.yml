name: CD â€” Build & Push to Docker Hub

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  IMAGE_NAME: gha-cicd-demo

jobs:
  call-build:
    name: Build+Push Image
    uses: ./.github/workflows/cd-dockerhub.yml
    with:
      image_name: ${{ env.IMAGE_NAME }}
      tag: ${{ github.sha }}
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

  conditional-release:
    name: Promote tag to latest (conditional)
    needs: call-build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/heads/main')
    steps:
      - name: Promote to latest by re-tagging
        run: |
          docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" -p "${{ secrets.DOCKERHUB_TOKEN }}"
          docker pull ${{ needs.call-build.outputs.image }}
          docker tag ${{ needs.call-build.outputs.image }} ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
